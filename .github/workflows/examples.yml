name: Example operations

on: [push]

permissions:
  contents: read
defaults:
  run:
    working-directory: src

jobs:
  format:
    name: Check formatting
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Lint with flake8
      run: |
        pip3 install .[flake8]
        flake8 . --count --statistics

  typing:
    name: Check typing
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Check with ty
      run: |
        # workaround ty issue https://github.com/astral-sh/ty/issues/1323
        pip3 install virtualenv
        virtualenv .venv
        source .venv/bin/activate
        pip3 install .[ty]
        python3 -m ty check bpsec_cose

  build:
    name: Build and test
    strategy:
      max-parallel: 4
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install
      run: pip3 install -e .
    - name: BPSec examples
      run: |
        pip3 install .[test]
        python3 -m pytest . --capture=no
    - name: PKI examples
      run: |
        python3 -m bpsec_cose.pki.run
        ./bpsec_cose/pki/check.sh
